<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pred-man-cli</title>
    <script>
      (() => {
        const matchesAuthHost = (url) => {
          try {
            const u = new URL(url, document.baseURI);
            return (
              u.hostname === "relay.dynamicauth.com" ||
              /\.dynamicauth\.com$/.test(u.hostname)
            );
          } catch {
            return false;
          }
        };

        const markCredentialless = (iframe) => {
          try {
            iframe.credentialless = true;
          } catch {}
        };

        try {
          const desc = Object.getOwnPropertyDescriptor(
            HTMLIFrameElement.prototype,
            "src"
          );
          if (desc && desc.set) {
            const originalSet = desc.set;
            Object.defineProperty(HTMLIFrameElement.prototype, "src", {
              configurable: true,
              enumerable: desc.enumerable,
              get: desc.get,
              set(value) {
                if (matchesAuthHost(value)) markCredentialless(this);
                return originalSet.call(this, value);
              },
            });
          }
        } catch {}

        try {
          const originalSetAttribute = Element.prototype.setAttribute;
          Element.prototype.setAttribute = function (name, value) {
            if (
              this instanceof HTMLIFrameElement &&
              name &&
              name.toLowerCase() === "src" &&
              matchesAuthHost(value)
            ) {
              markCredentialless(this);
            }
            return originalSetAttribute.call(this, name, value);
          };
        } catch {}

        try {
          const checkAndMark = (iframe) => {
            const value = iframe.getAttribute("src") || iframe.src;
            if (value && matchesAuthHost(value)) markCredentialless(iframe);
          };
          const observer = new MutationObserver((mutations) => {
            for (const m of mutations) {
              if (m.type === "childList") {
                for (const node of m.addedNodes) {
                  if (node instanceof HTMLIFrameElement) {
                    checkAndMark(node);
                  } else if (node && node.querySelectorAll) {
                    node.querySelectorAll("iframe").forEach(checkAndMark);
                  }
                }
              } else if (
                m.type === "attributes" &&
                m.target instanceof HTMLIFrameElement &&
                m.attributeName === "src"
              ) {
                checkAndMark(m.target);
              }
            }
          });

          observer.observe(document.documentElement, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ["src"],
          });
        } catch {}
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
